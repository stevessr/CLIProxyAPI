name: Build OpenWrt Packages

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  OPENWRT_VERSION: openwrt-23.05

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch:
          - aarch64_generic
          - arm_cortex-a9
          - mips_24kc
          - mipsel_24kc
          - x86_64
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev libncurses5-dev \
            libncursesw5-dev libssl-dev python3 python3-dev python3-distutils \
            python3-setuptools rsync subversion swig time unzip wget xsltproc \
            zlib1g-dev
      
      - name: Clone OpenWrt
        run: |
          git clone --depth=1 --branch=${{ env.OPENWRT_VERSION }} https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      
      - name: Copy package files
        run: |
          mkdir -p openwrt/package/custom
          cp -r openwrt/cli-proxy-api openwrt/package/custom/
          cp -r openwrt/luci-app-cli-proxy-api openwrt/package/custom/
      
      - name: Configure OpenWrt
        run: |
          cd openwrt
          
          # Set architecture-specific target
          case "${{ matrix.arch }}" in
            aarch64_generic)
              echo "CONFIG_TARGET_armsr=y" >> .config
              echo "CONFIG_TARGET_armsr_armv8=y" >> .config
              ;;
            arm_cortex-a9)
              echo "CONFIG_TARGET_armsr=y" >> .config
              echo "CONFIG_TARGET_armsr_armv7=y" >> .config
              ;;
            mips_24kc)
              echo "CONFIG_TARGET_ath79=y" >> .config
              echo "CONFIG_TARGET_ath79_generic=y" >> .config
              ;;
            mipsel_24kc)
              echo "CONFIG_TARGET_ramips=y" >> .config
              echo "CONFIG_TARGET_ramips_mt7621=y" >> .config
              ;;
            x86_64)
              echo "CONFIG_TARGET_x86=y" >> .config
              echo "CONFIG_TARGET_x86_64=y" >> .config
              ;;
          esac
          
          cat >> .config <<EOF
          CONFIG_PACKAGE_cli-proxy-api=m
          CONFIG_PACKAGE_luci-app-cli-proxy-api=m
          CONFIG_PACKAGE_golang=y
          EOF
          make defconfig
      
      - name: Download packages
        run: |
          cd openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
      
      - name: Build packages
        run: |
          cd openwrt
          make package/cli-proxy-api/compile -j$(nproc) V=s
          make package/luci-app-cli-proxy-api/compile -j$(nproc) V=s
      
      - name: Collect packages
        run: |
          mkdir -p artifacts
          find openwrt/bin/packages -name 'cli-proxy-api*.ipk' -exec cp {} artifacts/ \;
          find openwrt/bin/packages -name 'luci-app-cli-proxy-api*.ipk' -exec cp {} artifacts/ \;
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-packages-${{ matrix.arch }}
          path: artifacts/*.ipk
          retention-days: 7
  
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*.ipk
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
