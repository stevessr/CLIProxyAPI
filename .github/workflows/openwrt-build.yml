name: Build OpenWrt Packages

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  OPENWRT_VERSION: openwrt-23.05

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        arch:
          - aarch64_generic
          - arm_cortex-a9
          - arm_cortex-a53
          - x86_64
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev libncurses5-dev \
            libncursesw5-dev libssl-dev python3 python3-dev python3-setuptools \
            rsync subversion swig time unzip wget xsltproc zlib1g-dev
      
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-openwrt-${{ matrix.arch }}-${{ hashFiles('openwrt/**/*') }}
          restore-keys: |
            ccache-openwrt-${{ matrix.arch }}-
            ccache-openwrt-
      
      
      
      - name: Cache OpenWrt source
        id: cache-openwrt
        uses: actions/cache@v4
        with:
          path: openwrt
          key: openwrt-${{ env.OPENWRT_VERSION }}-${{ hashFiles('go.mod', 'go.sum', 'openwrt/**/*') }}
          restore-keys: |
            openwrt-${{ env.OPENWRT_VERSION }}-
            openwrt-
      
      - name: Clone OpenWrt
        run: |
          if [ ! -d "openwrt" ]; then
            mv openwrt opc
            git clone --depth=1 --branch=${{ env.OPENWRT_VERSION }} https://github.com/openwrt/openwrt.git openwrt
          else
            mv openwrt opc
            if [ ! -d "opc" ]; then
              git clone --depth=1 --branch=${{ env.OPENWRT_VERSION }} https://github.com/openwrt/openwrt.git opc
            fi
          fi
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      
      - name: Cache OpenWrt feeds
        uses: actions/cache@v4
        with:
          path: openwrt/feeds
          key: openwrt-feeds-${{ env.OPENWRT_VERSION }}-${{ hashFiles('openwrt/feeds.conf.default') }}
          restore-keys: |
            openwrt-feeds-${{ env.OPENWRT_VERSION }}-
            openwrt-feeds-
      
      - name: Cache OpenWrt dl
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: openwrt-dl-${{ env.OPENWRT_VERSION }}-${{ hashFiles('openwrt/package/*/Makefile') }}
          restore-keys: |
            openwrt-dl-${{ env.OPENWRT_VERSION }}-
            openwrt-dl-
      
      - name: Copy package files
        run: |
          mkdir -p openwrt/package/custom
          cp -r ./opc/cli-proxy-api openwrt/package/custom/
          cp -r ./opc/luci-app-cli-proxy-api openwrt/package/custom/
      
      - name: Configure OpenWrt
        run: |
          cd openwrt
          
          # Set architecture-specific target
          case "${{ matrix.arch }}" in
            aarch64_generic)
              echo "CONFIG_TARGET_armsr=y" >> .config
              echo "CONFIG_TARGET_armsr_armv8=y" >> .config
              ;;
            arm_cortex-a9)
              echo "CONFIG_TARGET_armsr=y" >> .config
              echo "CONFIG_TARGET_armsr_armv7=y" >> .config
              ;;
            arm_cortex-a53)
              echo "CONFIG_TARGET_armsr=y" >> .config
              echo "CONFIG_TARGET_armsr_armv8=y" >> .config
              ;;
            x86_64)
              echo "CONFIG_TARGET_x86=y" >> .config
              echo "CONFIG_TARGET_x86_64=y" >> .config
              ;;
          esac
          
          cat >> .config <<EOF
          CONFIG_PACKAGE_cli-proxy-api=m
          CONFIG_PACKAGE_luci-app-cli-proxy-api=m
          CONFIG_PACKAGE_golang=y
          CONFIG_CCACHE=y
          EOF
          make defconfig
      
      - name: Download packages
        run: |
          cd openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
      
      - name: Build packages
        run: |
          cd openwrt
          export CCACHE_DIR=~/.ccache
          ccache -s
          make package/cli-proxy-api/compile -j$(nproc) V=s
          make package/luci-app-cli-proxy-api/compile -j$(nproc) V=s
          ccache -s
      
      - name: Collect packages
        run: |
          mkdir -p artifacts
          find openwrt/bin/packages -name 'cli-proxy-api*.ipk' -exec cp {} artifacts/ \;
          find openwrt/bin/packages -name 'luci-app-cli-proxy-api*.ipk' -exec cp {} artifacts/ \;
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-packages-${{ matrix.arch }}
          path: artifacts/*.ipk
          retention-days: 7
  
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*.ipk
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
